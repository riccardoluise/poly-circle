<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cerchi Luminosi e Sonori</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: Arial, sans-serif;
      }
      canvas {
        border: 1px solid #333;
      }
      #controls {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 5px;
      }
      button:hover {
        background-color: #555;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <div id="controls">
      <button id="startButton">Avvia Audio</button>
      <button id="chromaticButton">Scala Cromatica</button>
      <button id="kalimbaButton">Kalimba</button>
      <button id="pentatonicButton">Pentatonica</button>
      <button id="hangDrumButton">Hang Drum</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
      // Modulo dei parametri
      const Params = {
        numRays: 64,
        radius: 0,
        targetFPS: 30,
        scales: {
          chromatic: [
            "C3",
            "C#3",
            "D3",
            "D#3",
            "E3",
            "F3",
            "F#3",
            "G3",
            "G#3",
            "A3",
            "A#3",
            "B3",
            "C4",
            "C#4",
            "D4",
            "D#4",
            "E4",
            "F4",
            "F#4",
            "G4",
            "G#4",
            "A4",
            "A#4",
            "B4",
          ],
          kalimba: [
            "C3",
            "D3",
            "E3",
            "G3",
            "A3",
            "C4",
            "D4",
            "E4",
            "G4",
            "A4",
            "C5",
            "D5",
            "E5",
            "G5",
            "A5",
          ],
          pentatonic: [
            "C3",
            "D3",
            "E3",
            "G3",
            "A3",
            "C4",
            "D4",
            "E4",
            "G4",
            "A4",
            "C5",
            "D5",
            "E5",
            "G5",
            "A5",
          ],
          hangDrum: [
            "D3",
            "A3",
            "C4",
            "D4",
            "F4",
            "G4",
            "A4",
            "C5",
            "D5",
            "F5",
            "G5",
            "A5",
            "C6",
            "D6",
            "F6",
          ],
        },
        currentScale: "chromatic",
        distributedNotes: [],
      };

      // Funzione per distribuire le note
      function distributeNotes() {
        const scale = Params.scales[Params.currentScale];
        Params.distributedNotes = [];
        const notesPerRay = Math.floor(Params.numRays / scale.length);
        let remainingRays = Params.numRays % scale.length;

        for (let i = 0; i < scale.length; i++) {
          let repeatCount = notesPerRay + (remainingRays > 0 ? 1 : 0);
          for (let j = 0; j < repeatCount; j++) {
            Params.distributedNotes.push(scale[i]);
          }
          if (remainingRays > 0) remainingRays--;
        }
      }

      // Modulo grafico
      const Graphics = {
        canvas: null,
        ctx: null,
        centerX: 0,
        centerY: 0,

        init(canvasId) {
          this.canvas = document.getElementById(canvasId);
          this.ctx = this.canvas.getContext("2d");
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
          this.centerX = this.canvas.width / 2;
          this.centerY = this.canvas.height / 2;
          Params.radius = Math.min(this.canvas.width, this.canvas.height) * 0.4;
        },

        drawCircumference() {
          this.ctx.beginPath();
          this.ctx.arc(
            this.centerX,
            this.centerY,
            Params.radius,
            0,
            Math.PI * 2
          );
          this.ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
          this.ctx.stroke();
        },

        drawRays() {
          this.ctx.beginPath();
          for (let i = 0; i < Params.numRays; i++) {
            const angle = (i / Params.numRays) * Math.PI * 2;
            this.ctx.moveTo(this.centerX, this.centerY);
            this.ctx.lineTo(
              this.centerX + Math.cos(angle) * Params.radius,
              this.centerY + Math.sin(angle) * Params.radius
            );
          }
          this.ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
          this.ctx.stroke();
        },

        clear() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
      };

      // Modulo audio
      const Audio = {
        synth: null,
        reverb: null,
        compressor: null,

        init() {
          Tone.context.updateInterval = 0.1;
          Tone.context.lookAhead = 0.1;

          this.synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1.5 },
          }).toDestination();

          this.reverb = new Tone.Reverb({
            decay: 3,
            wet: 0.4,
          }).toDestination();

          this.compressor = new Tone.Compressor({
            threshold: -24,
            ratio: 12,
            attack: 0.003,
            release: 0.25,
          }).toDestination();

          this.synth.chain(this.reverb, this.compressor);
        },

        playNote(index) {
          if (!this.synth) return;
          const note = Params.distributedNotes[index];
          this.synth.triggerAttackRelease(note, "16n", undefined, 0.2);
        },
      };

      class Circle {
        constructor(index) {
          this.angle = (index / Params.numRays) * Math.PI * 2;
          this.distance = Params.radius;
          this.speed = Math.random() * 1 + 0.5;
          this.direction = -1;
          this.borderGlow = 0;
          this.index = index;
        }

        update() {
          this.distance += this.speed * this.direction;
          if (this.distance > Params.radius || this.distance < 0) {
            this.direction *= -1;
            if (this.distance > Params.radius) {
              this.borderGlow = 1;
              Audio.playNote(this.index);
            }
          }
          this.borderGlow *= 0.9;
        }

        draw() {
          const x = Graphics.centerX + Math.cos(this.angle) * this.distance;
          const y = Graphics.centerY + Math.sin(this.angle) * this.distance;

          Graphics.ctx.beginPath();
          Graphics.ctx.arc(x, y, 2, 0, Math.PI * 2);
          Graphics.ctx.fillStyle = "white";
          Graphics.ctx.fill();

          if (this.borderGlow > 0) {
            Graphics.ctx.beginPath();
            Graphics.ctx.arc(x, y, 4, 0, Math.PI * 2);
            Graphics.ctx.strokeStyle = `rgba(255, 255, 255, ${this.borderGlow})`;
            Graphics.ctx.lineWidth = 1.5;
            Graphics.ctx.stroke();
          }
        }
      }

      // Modulo principale dell'applicazione
      const App = {
        circles: [],
        lastFrameTime: 0,
        frameInterval: 1000 / Params.targetFPS,

        init() {
          Graphics.init("myCanvas");
          Audio.init();
          distributeNotes();
          this.initializeCircles();
          this.setupEventListeners();
        },

        initializeCircles() {
          this.circles = [];
          for (let i = 0; i < Params.numRays; i++) {
            this.circles.push(new Circle(i));
          }
        },

        setupEventListeners() {
          document
            .getElementById("startButton")
            .addEventListener("click", async () => {
              await Tone.start();
              document.getElementById("startButton").style.display = "none";
              this.animate();
            });

          document
            .getElementById("chromaticButton")
            .addEventListener("click", () => this.changeScale("chromatic"));
          document
            .getElementById("kalimbaButton")
            .addEventListener("click", () => this.changeScale("kalimba"));
          document
            .getElementById("pentatonicButton")
            .addEventListener("click", () => this.changeScale("pentatonic"));
          document
            .getElementById("hangDrumButton")
            .addEventListener("click", () => this.changeScale("hangDrum"));
        },

        changeScale(scaleName) {
          Params.currentScale = scaleName;
          distributeNotes();
          this.initializeCircles();
        },

        animate(currentTime) {
          if (currentTime - this.lastFrameTime < this.frameInterval) {
            requestAnimationFrame(this.animate.bind(this));
            return;
          }

          this.lastFrameTime = currentTime;

          Graphics.clear();
          Graphics.drawCircumference();
          Graphics.drawRays();

          this.circles.forEach((circle) => {
            circle.update();
            circle.draw();
          });

          requestAnimationFrame(this.animate.bind(this));
        },
      };

      // Inizializzazione dell'applicazione
      App.init();
    </script>
  </body>
</html>
